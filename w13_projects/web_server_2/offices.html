<!DOCTYPE html>
<html lang="en-IN">

<head>
    <title>offices</title>
</head>

<body>
    <form method="POST" action="/office_search_id">
        <button onclick="getCustomersFetch()">Get all customers via GET fetch</button><br>
    </form>

    Status: <b><span id="status">Click a button above</span></b><br>

    Server response: <div id="response"> None</div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>

    /* FETCH *************************************************************************************/

    function getCustomersFetch() {

        fetch("http://localhost:8000/offices",
            {
                method: 'GET',
            }
        )
            .then(res => res.json())//here server sends JSON response
            .then(
                (response) => {
                    // TO DO how to handle code other than 200 because this gets
                    // exeucted in all cases
                    let offices = response.offices;
                    let html = ''
                    document.getElementById("status").innerHTML = "Number of offices:" + offices.length
                    console.log(offices)
                    html = "<table>"
                    for (let i = 0; i < offices.length; i++) {
                        html += "<tr><td>" + offices[i].officecode + "</td><td>" + offices[i].city + "</td><td>" + offices[i].addressline1 + "</td>"
                    }
                    html += "</table>"
                    document.getElementById("response").innerHTML = html
                },
                (error) => {
                    // only NO RESPONSE URL errors will trigger this code
                    document.getElementById("status").innerHTML = "AJAX error: URL wrong or unreachable, see console"
                }
            )
    }

    function loginFetch() {
        let userData = {
            username: "toto",
            password: "12345678"
        }

        fetch("http://localhost:8000/form_validate",
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *client
                body: JSON.stringify(userData)
            }
        )
            .then(
                (response) => {
                    // here reponse is the full fetch response object
                    console.log(response)
                    // Any response, all error code 200, 404, â€¦ will execute this code (not like Jquery)
                    if (response.status === 200) {
                        // handle 200 success only
                        document.getElementById("status").innerHTML = "AJAX response OK !"
                        console.log(response.text())
                    } else {
                        document.getElementById("status").innerHTML = "Error: server returned error code: " + response.status
                    }
                },
                (error) => {
                    // only NO RESPONSE URL errors will trigger this code
                    console.log(error)
                    document.getElementById("status").innerHTML = "AJAX error: URL wrong or unreachable, see console"
                }
            )
    }//end of login function
    function CustomerDeleteFetch() {
        fetch("http://localhost:8000/offices/7",
            {
                method: 'DELETE'
                //,body: JSON.stringify(someData)// data to send in the body of the request
            }
        )
            .then(res => res.text())// here server sends text/html response
            .then(
                (response) => {
                    // TO DO how to handle code other than 200 because this gets
                    // exeucted in all cases
                    document.getElementById("status").innerHTML = response
                },
                (error) => {
                    // only NO RESPONSE URL errors will trigger this code
                    document.getElementById("status").innerHTML = "AJAX error: URL wrong or unreachable, see console"
                }
            )
    }
    // end of CustomerDeleteFetch() function
    /* JQUERY ************************************************************************************/
    // handles all JQuery AJAX errors, any response code other than 2xx
    $(document).ajaxError(function (event, xhr, options, exc) {
        $("#status").html("An AJAX error occurred: " + xhr.status + " " + xhr.text_status);
    });
    $("#some_button").click(
        function () {
            // using the Jquery $.get function for AJAX call
            $.get(
                // web server URL to call
                "/offices",
                // callback function to execute after server response is received
                function (returned_data, text_status, xhr) {
                    // here only ok response code 2xx will trigger this code
                    // data object received from server
                    console.log(returned_data)
                    let offices = returned_data.offices
                    console.log(offices)
                    $("#status").html("Number of offices: " + offices.length)
                }
            );
        }
    );
    $("#login_button").click(function () {
        $.post(
            // server URL where to send the data
            "/form_validate",
            // data to send
            {
                username: "toto",
                password: "12345678"
            },
            // callback function to execute after the response is received
            function (data, status, xhr) {
                $("#status").html("AJAX response OK !")
                alert("Data: " + data + "\nStatus: " + status);
            }
        );

    });



    $("#delete_button").click(function () {

        $.ajax({

            url: "/offices/7",

            type: "DELETE",

            data: {},// data to send in the body of the request

            success: function (result) {

                // OK code 2xx display the returned message

                $("#status").html("AJAX response:" + result)

            },

            error: function (xhr, textStatus, errorThrown) {

                // will not be executed if .ajaxError above catches all errors before this

                // any error code returned other than 2xx

                // example display response code in a status div

                $("#status").html(xhr.status)

                $("#status").html(xhr.responseText)//if server returns text/html

                // example append "message" property from a JSON object returned by our API

                //$("#status").append(xhr.responseJSON.message) // if server returns JSON

            }

        });

    });

</script>

</html>